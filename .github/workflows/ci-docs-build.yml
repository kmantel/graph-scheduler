name: Docs CI Build

on:
  push:
    branches-ignore:
      - 'dependabot/**'
    tags:
      - 'v*'
  pull_request:

jobs:
  docs-build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      # Matrix setup is a hacky way to include 'base' build in pull requests
      # The entire matrix is set up and 'base' builds are pruned based
      # on event name and final configuration (ubuntu, python3.7).
      matrix:
        python-version: [3.7, 3.8, 3.9]
        python-architecture: ['x64']
        os: [ubuntu-latest]
        event:
          - ${{ github.event_name }}

    outputs:
      on_main: ${{ steps.on_main.outputs.on-branch }}

    steps:
    - name: Checkout sources
      uses: actions/checkout@v2.3.5
      with:
        # need history and tags for versioneer
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2.2.2
      with:
        python-version: ${{ matrix.python-version }}
        architecture: ${{ matrix.python-architecture }}

    - name: Get pip cache location
      shell: bash
      id: pip_cache
      run: |
        python -m pip install -U pip
        python -m pip --version
        echo ::set-output name=pip_cache_dir::$(python -m pip cache dir)

    - name: Wheels cache
      uses: actions/cache@v2.1.6
      with:
        path: ${{ steps.pip_cache.outputs.pip_cache_dir }}/wheels
        key: ${{ runner.os }}-python-${{ matrix.python-version }}-${{ matrix.python-architecture }}-pip-wheels-v2-${{ github.sha }}
        restore-keys: ${{ runner.os }}-python-${{ matrix.python-version }}-${{ matrix.python-architecture }}-pip-wheels-v2

    - name: Install local, editable package
      run: |
        python -m pip install --upgrade pip wheel
        python -m pip install -e .[docs]

    - name: Build Documentation
      run: make -C docs html

    - name: Upload Documentation
      uses: actions/upload-artifact@v2.2.4
      with:
        name: Documentation-${{ matrix.os }}-${{ matrix.python-version }}-${{ matrix.python-architecture }}
        retention-days: 1
        path: docs/_build/html

    - name: Check if on main
      if: ${{ github.event_name == 'push' }}
      id: on_main
      uses: ./.github/actions/on-branch
      with:
        branch: main

